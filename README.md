# Tspecies

An R package for estimating species divergence times using *Ks* distribution variance and effective population size (*Ne*) correction.

## Description

Tspecies employs a pre-fitted Generalized Additive Model (GAM) or uses the formula to predict ancestral effective population size (*Ne*) based on synonymous substitution rates (*Ks*) and neutral mutation rates (*μ*). It addresses the inherent bias in divergence time estimation by incorporating coalescent theory, where species divergence time differs from gene divergence time by \(2*Ne*\). The package automatically corrects *Ks* values using multiple substitution models and population genetics principles.

**Key Features**:
- Corrects divergence time estimates using *Ks* variance
- Requires only *Ks* distributions and neutral mutation rates
- Computationally efficient workflow
- Robust to moderate demographic fluctuations

## Installation

To install the development version from GitHub:

```r
if (!require("devtools")) install.packages("devtools")
devtools::install_github("limj0987/Tspecies")
```

## Quick Start

```
# Example dataset
Ks_values <- c(0.257, 0.202, 0.066, 0.197, 0.278, 0.089)
neutral_mutation_rate <- 8e-8  # 8×10⁻⁸ per generation

# Estimate divergence time
Tspecies(Ks = Ks_values, miu = neutral_mutation_rate)
```

## Usage

### Main Function

```
Tspecies(Ks, miu, g)
```

#### Arguments

- `Ks`: Numeric vector of synonymous substitution rates (d/L), where:
  - `d` = base differences between orthologous sequences
  - `L` = sequence length
- `miu`: *μ*, neutral mutation rate <u>per **generation** (numeric)</u>
  - Please make the conversion if the unit is 'per year'

- `g`: Generation time (year)
  - Optional input. The default `g` is 1 (year)


#### Returns

- Numeric value representing estimated species divergence time in generations (or in years if you input `g` value)
- Console output includes:
  - Predicted effective population size (*Ne*)
  - Divergence time estimate
  - **0** if divergence time ≤0 (indicating no divergence)
  - Corrected_*Ks* value (estimated species divergent distance corrected with 2*N*e and multiple substitution)
  - info message if using formula instead of pre-trained data

#### Output Example

```
The mutation rate is 9.06e-08 per site per generation 
The predicted number of effective population size is around 50814.1 
The generation time of this species is 30 years 
Estimated divegence time of the species: 1443859 (years) 
The corrected_Ks is 0.008720906 
```

```
Info: Ne will be calculated based on the preset formula.
The mutation rate is 6.05e-08 per site per generation 
The predicted number of effective population size is around 1908967 
The generation time of this species is 0.1 years 
Estimated divegence time of the species: 538849.7 (years)
The corrected_Ks is 0.7730081 
```

### Other Function

```
TspeciesPlot(Ks, bin = 0.006)
```

#### Arguements

- `Ks`: Numeric vector of synonymous substitution rates (d/L)
- `bin`: An numeric value of grouping a continuous variable into a smaller number of discrete intervals or ranges (this parameter can be appropriately adjusted to meet the expectation)

#### Returns

- A plot of *Ks* distribution generated by `ggplot2`

## Model Specifications

- 23 pre-trained GAM models covering *μ* from 1e-10 to 1e-7. All the datasets used in Tspecies are includeded in `inst/extdata` , which are versioned.
- Automatic model selection based on *μ* value and the size of *Ne*.
- Nonlinear relationship between *Ks* variance and *Ne*.
- As *Ne* becomes larger, it gets closer to the ideal state. When *Ne* exceeds 450,000, the accuracy of using the formula will be greater than that of the model prediction.

**ATTENTION**: The input *Ks* value would be pre-processed by the multiple substitution model, so be sure that is original. If *Ks* value is too large (greater than **0.75**, which usually indicates intraspecific backcrossing occurs within the population), the multiple substitution model will no longer be applicable due to computational reasons.  
multiple substitution model: $corrected\hspace{0.1em}K_s=-\frac{3}{4}ln(1-\frac{4K_s}{3})$

## Example Used in Paper

Please download the folder "example" and run the Rscript "example.R".

## License

This project is licensed under the **MIT License**.  
Copyright © 2025 Mijia 

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:  

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.  

For details, see [MIT License](https://opensource.org/licenses/MIT).  
